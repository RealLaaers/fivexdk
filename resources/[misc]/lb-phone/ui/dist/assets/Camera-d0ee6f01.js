import{u as v,r,q as l,b9 as pe,_ as be,A as j,ba as M,P as w,ax as re,p as u,bb as Ce,bc as Se,bd as ye,C as x,a as n,F as ne,j as p,be as Ae,bf as Ie,bg as Re,L as ie,s as E,bh as we,bi as Pe,aS as ke,bj as Oe,a2 as Ne,t as oe,a6 as Me,b1 as Ee,b as Ve,T as Le}from"./index-ab956fb7.js";function Fe(){var te;const m=v(Ve);v(x.CameraComponent);const H=v(M.Unlocked),ce=v(M.PassedFaceId),y=v(M.Visible);v(M.LockScreenVisible);const[F,A]=r.useState(!1),[o,T]=r.useState("Photo"),[V,X]=r.useState(!1),[le,G]=r.useState(!1),[W,L]=r.useState(null),[b,q]=r.useState(!1),[g,Q]=r.useState(!1),[_,J]=r.useState(0),[ue,$]=r.useState({}),d=v(Le),f=v(j),z=r.useRef(null),B=r.useRef(null),I=r.useRef(null),c=r.useRef(null),C=r.useRef(null),P=r.useRef(!1),h=["Video","Photo","Landscape"],Y=()=>{o==="Photo"&&b&&!m.CustomCamera?c.current.setXOffset(-.2):b&&m.CustomCamera?c.current.setXOffset(.1):c.current.setXOffset(0)},de=()=>{if(l("info","Camera app is active & open, initializing game render & audio stream"),u("Camera",{action:"open"}),c.current&&c.current.resume(),C.current||Pe("Camera").then(e=>{e&&(C.current=e)}),u("Camera",{action:"flipCamera",value:b},"OK"),E.APPS.CAMERA.lastImage.value)return K(E.APPS.CAMERA.lastImage.value);u("Camera",{action:"getLastImage"},ke.Photos[0].src).then(e=>{e&&K(e)})},fe=()=>{l("info","Camera app is not active or open, pausing game render & releasing audio stream"),u("Camera",{action:"close"}),g&&Q(!1),c.current&&c.current.pause(),C.current&&(Oe("Camera"),C.current=null)};r.useEffect(()=>{var s,t;const e=!(d!=null&&d.visible)&&((s=f==null?void 0:f.active)==null?void 0:s.name)==="Camera"&&y;P.current!==e&&(P.current=e,l("info","Camera app active:",e,d==null?void 0:d.visible,(t=f==null?void 0:f.active)==null?void 0:t.name,y),e?de():fe())},[d==null?void 0:d.visible,(te=f==null?void 0:f.active)==null?void 0:te.name,c.current,y]),r.useEffect(()=>{!I.current||c.current||(c.current=new pe(I.current))},[I.current]),be("camera:usedCommand",e=>{var s;if(d!=null&&d.visible||((s=f==null?void 0:f.active)==null?void 0:s.name)!=="Camera"||!y)return l("info","camera:usedCommand - camera is not active, returning");switch(e){case"toggleTaking":k();break;case"toggleFlip":q(t=>!t);break;case"toggleFlash":X(t=>!t);break;case"leftMode":if(g)return;T(t=>{const a=h.indexOf(t);return a===0?h[h.length-1]:h[a-1]});break;case"rightMode":if(g)return;T(t=>{const a=h.indexOf(t);return a===h.length-1?h[0]:h[a+1]});break}}),r.useEffect(()=>{if(!B.current)return;let e=[];const t=setInterval(()=>{e.length>2&&(e=[]),e.push("."),B.current.innerText=ie("APPS.CAMERA.UPLOADING")+e.join("")},500);return()=>clearInterval(t)},[F]);const K=(e,s)=>{if(s===void 0&&(s=Ne(e)),s){const t=document.createElement("video");t.src=e,t.muted=!0,t.play().catch(()=>{});const a=document.createElement("canvas");if(!a)return;t.addEventListener("loadeddata",()=>{a.width=t.videoWidth,a.height=t.videoHeight,a.getContext("2d").drawImage(t,0,0,a.width,a.height);const R=a.toDataURL("image/png");z.current.style.backgroundImage=`url(${R})`,E.APPS.CAMERA.lastImage.set(R),a.remove(),t.remove()})}else z.current.style.backgroundImage=`url(${e})`,E.APPS.CAMERA.lastImage.set(e)};r.useEffect(()=>{if(!y)return()=>{j.patch({active:null}),H||M.LockScreenVisible.set(!0)}},[y]),r.useEffect(()=>{var s,t;if(g||!c.current||!P.current)return;switch(o){case"Landscape":if((s=re)!=null&&s.value)return;$({marginRight:"9rem"}),w.Styles.Rotation.set(90);break;case"Video":w.Styles.Rotation.set(0),$({marginLeft:"12rem"});break;default:w.Styles.Rotation.set(0),$({marginLeft:"3rem"});break}if(o==="Landscape"){if((t=re)!=null&&t.value)return;c.current.resizeByAspect(16/9)}else(o==="Video"||o==="Photo")&&c.current.resizeByAspect(3/4);u("Camera",{action:"toggleLandscape",toggled:o==="Landscape"},"OK"),u("Camera",{action:"toggleVideo",toggled:o==="Video"},"OK");const e=window.innerWidth;e>1920&&c.current.setQuality(1920/e),Y()},[o,P.current]),r.useEffect(()=>{if(!P.current)return l("info","camera app is not active, not triggering flipCamera");u("Camera",{action:"flipCamera",value:b},"OK"),Y()},[b]);const Z=r.useRef(!0),ee=async(e,s)=>{const t=oe(e.size/1e3,2);V&&u("toggleFlashlight",{toggled:!1},"OK");try{const a=await Me(s?"Video":"Image",e);if(!a)throw new Error("Failed to upload media (URL is null)");return K(a),l("info",`Saving ${s?"video":"photo"} to gallery (${t}kb) - ${a}, args(${a}, ${t}, ${b&&!s?"selfie":null})`),await Ee(a,t,b&&!s?"selfie":null,!0),!0}catch(a){throw a}};r.useEffect(()=>{if(Z.current){Z.current=!1;return}if(V&&!g&&u("toggleFlashlight",{toggled:!1},"OK"),!g)return;const e=I.current.captureStream(m.videoOptions.fps),s=new AudioContext,t=new MediaStreamAudioDestinationNode(s);C.current?s.createMediaStreamSource(C.current).connect(t):s.createOscillator().connect(t),Ce("Camera",s,t);const a=[e.getVideoTracks()[0]];(C.current||m.recordNearbyVoices)&&a.unshift(t.stream.getAudioTracks()[0]);const R=new MediaStream(a),S=new MediaRecorder(R,{mimeType:"video/webm;codecs=vp9,opus",videoBitsPerSecond:m.videoOptions.bitrate*8*1e3});let D=0;const ge=S.audioBitsPerSecond+S.videoBitsPerSecond,ae=setInterval(()=>{const i=(Date.now()-D)/1e3,U=ge*i/8/1024/1024,N=oe(U,2);N>=m.videoOptions.size&&(l("info",`Video file size limit reached (${N}mb)`),clearInterval(ae),k())},100);let se=[];S.ondataavailable=i=>{var O;((O=i==null?void 0:i.data)==null?void 0:O.size)>0&&se.push(i.data)},S.onerror=i=>{l("error","error recording:",i)},S.onstop=async()=>{clearInterval(ae);let i=Date.now()-D,O=new Blob(se,{type:"video/webm"});s.close(),A(!0),Se("Camera");const U=await ye(O,i,{logger:!1});try{await ee(U,!0),l("info","Video uploaded successfully"),A(!1)}catch(N){l("error","Could not upload video",N),A(!1),L(N.message),await new Promise(ve=>setTimeout(ve,1e4)),L(null)}},D=Date.now(),S.start();const he=setInterval(()=>{if(_>=m.videoOptions.duration)return k();J(i=>i+1>=m.videoOptions.duration?(k(),0):i+1)},1e3);return()=>{J(0),clearInterval(he),S.stop()}},[g]);const me=e=>{let s=(e%60).toString().padStart(2,"0"),t=(Math.floor(e/60)%60).toString().padStart(2,"0");return Math.floor(e/3600).toString().padStart(2,"0")+":"+t+":"+s},k=async()=>{var s,t;if(F)return l("info","Returning since an image is currently uploading");if(V&&await u("toggleFlashlight",{toggled:!0},"OK"),o=="Video"){await u("Camera",{action:"toggleHud",toggled:g},"OK"),Q(a=>!a);return}await u("Camera",{action:"toggleHud",toggled:!1},"OK"),(t=(s=w.Settings.value)==null?void 0:s.sound)!=null&&t.silent||w.SoundManager.set({url:"./assets/sound/other/cameraShutter.mp3"}),G(!0),x.IndicatorVisible.set(!1),A(!0),l("info","Uploading image, converting to blob");const e=await new Promise(a=>I.current.toBlob(a,m.imageOptions.mime,m.imageOptions.quality));try{await ee(e,!1),l("info","Image uploaded successfully"),A(!1),x.IndicatorVisible.set(!0)}catch(a){l("error","Could not upload image",a),A(!1),L(a.message),x.IndicatorVisible.set(!0),await new Promise(R=>setTimeout(R,1e4)),L(null)}G(!1),u("Camera",{action:"toggleHud",toggled:!0},"OK")};return n(ne,{children:p("div",{className:"camera-container",children:[p("div",{className:"camera-header",children:[n("div",{className:"flash",onClick:()=>X(e=>!e),children:!g&&V?n(Ae,{}):n(Ie,{})}),o==="Video"&&p(ne,{children:[n("div",{className:"timer",children:me(_)}),n("span",{})]})]}),p("div",{className:`camera-body ${o=="Landscape"?"rotate":""}`,children:[n("canvas",{ref:I,style:{visibility:le?"hidden":"visible"}}),F&&p("div",{className:"loading",children:[n(Re,{size:80,speed:1,color:"#ffffff"}),n("div",{className:"uploading",ref:B,children:"Uploading..."})]}),W&&n("div",{className:"loading",children:p("div",{className:"uploading",children:["Failed to upload, tell the server owner to check their API keys in lb-phone/server/apiKeys.lua",n("br",{}),n("br",{}),W]})})]}),p("div",{className:"camera-bottom",children:[n("div",{className:"camera-types",style:ue,children:h.map((e,s)=>n("div",{className:`${o===e&&"active"}`,onClick:()=>T(e),children:ie(`APPS.CAMERA.${e.toUpperCase()}`)},s))}),p("div",{className:"camera-buttons",children:[n("div",{className:"image-gallery",ref:z,onClick:()=>{!ce&&!H||(u("Camera",{action:"close"},"OK"),w.Styles.Rotation.set(0),j.patch({active:{name:"Photos",data:{photo:E.APPS.CAMERA.lastImage.value}}}))}}),n("div",{className:"camera-button",onClick:()=>k(),children:n("div",{className:"camera-button-container",children:n("div",{className:`camera-button-inner ${o=="Video"&&`${o} ${g==!0&&"Recording"}`}`})})}),n("div",{className:"flip-camera",onClick:()=>q(e=>!e),children:n(we,{})})]})]})]})})}export{Fe as default};
